var MapCanvas={box:3,watchTowers:[],selected_x:null,selected_y:null,church_radius_colors:[[0,0,0],[254,216,177],[253,173,92],[252,139,24]],init:function(){var a;if(this.churchData)for(a=0;a<this.churchData.length;a++)this.churchData[a][2]*=this.churchData[a][2]},createCanvas:function(a,t){var e=document.createElement("canvas");if(!e||!e.getContext)return null;var r=TWMap.map.scale,h=TWMap.map.sectorSize;e.id="map_canvas_"+a.x+"_"+a.y,e.className="church_radius_display",e.width=r[0]*h,e.height=r[1]*h,e.style.position="absolute",e.style.zIndex="10",a.appendElement(e,0,0);var i=e.getContext("2d");if(i.save(),TribalWars._settings.map_show_watchtower)for(J=0;J<this.watchTowers.length;J++){var l=this.watchTowers[J][0],s=this.watchTowers[J][1],n=this.watchTowers[J][2];if(this.circleCollidesWithSector({x:l+.5,y:s+.5,r:n},{x:a.x,y:a.y,w:TWMap.map.sectorSize,h:TWMap.map.sectorSize})){var o=TWMap.map.pixelByCoord(l,s),c=TWMap.map.pixelByCoord(a.x,a.y),p=o[0]-c[0],u=o[1]-c[1];i.beginPath(),MapCanvas.ellipse(i,p+TWMap.tileSize[0]/2,u+TWMap.tileSize[1]/2,n*TWMap.map.scale[0],n*TWMap.map.scale[1],0,0,2*Math.PI,!1),i.fillStyle="rgba(235, 38, 38, 0.1)",i.fill(),i.lineWidth=1,i.strokeStyle="#563f1e",i.stroke()}}var d=this.churchData,f=t.pmap[0],v=t.pmap[1];f.length<1&&(f=null);var M,y,m,w=e.offsetWidth/h,T=e.offsetHeight/h;i.scale(w/37.75,T/37.75);var B,g=TWMap.politicalMap.filter%8,W=TWMap.attackPlannerMode,I=!W&&TWMap.politicalMap.displayed&&16&TWMap.politicalMap.filter;for(W&&(B=AttackPlanner.getMapInfo()),y=a.y-1;y<a.y+h+1;y++)for(M=a.x-1;M<a.x+h+1;M++){if(W){var _=1e3*M+y;B&&TWMap.villages.hasOwnProperty(_)&&B[TWMap.villages[_].id]&&this.mapDrawCell(i,M-a.x,y-a.y,[!1,!1,!1,!1,!0,!1,!1,!1,!1],["255","255","255"],19,19,.6)}if(I){var x=M-t.x+1,C=y-t.y+1;_=x+22*C;if(f&&0!==f[_]){var S=x-1+22*(C-1),D=x+22*(C-1),b=x+1+22*(C-1),L=x-1+22*C,P=x+1+22*C,z=x-1+22*(C+1),G=x+22*(C+1),k=x+1+22*(C+1),R=x<1,q=x>=21,O=C<1,E=C>=21;if(1==g||f[_]==game_data.player.id){m=[R||O?0:f[S],O?0:f[D],q||O?0:f[b],R?0:f[L],f[_],q?0:f[P],R||E?0:f[z],E?0:f[G],E||q?0:f[k]];var Q,A=f[_],H=v[_];Q=TWMap.getColorByPlayer(A,H),this.mapDrawCell(i,M-a.x,y-a.y,m,Q,19,19,.6)}(1==g||2==g||4!=g&&v[_]==game_data.player.ally)&&(m=[R||O?0:v[S],O?0:v[D],q||O?0:v[b],R?0:v[L],v[_],q?0:v[P],R||E?0:v[z],E?0:v[G],E||q?0:v[k]],this.mapDrawCell(i,M-a.x,y-a.y,m,[0,0,0],5,19,1))}}if(TWMap.church.displayed&&d){for(m=[!1,!1,!1,!1,!1,!1,!1,!1,!1],J=0;J<d.length;J++){var N=d[J][0],j=d[J][1],F=d[J][2];m=[m[0]||this.churchInBound(M-1,y-1,N,j,F),m[1]||this.churchInBound(M,y-1,N,j,F),m[2]||this.churchInBound(M+1,y-1,N,j,F),m[3]||this.churchInBound(M-1,y,N,j,F),m[4]||this.churchInBound(M,y,N,j,F),m[5]||this.churchInBound(M+1,y,N,j,F),m[6]||this.churchInBound(M-1,y+1,N,j,F),m[7]||this.churchInBound(M,y+1,N,j,F),m[8]||this.churchInBound(M+1,y+1,N,j,F)]}this.mapDrawCell(i,M-a.x,y-a.y,m,[0,0,128],19,19,.5)}if(TWMap.church.possible_displayed)for(var J=0;J<TWMap.church.levels.length;J++){var K=[[MapCanvas.selected_x,MapCanvas.selected_y]];null!=MapCanvas.selected_x&&null!=MapCanvas.selected_y&&this.drawMapRadiusByLevel(i,K,a,M,y,TWMap.church.levels[J])}}return i.restore(),i=null,e=null,null},circleCollidesWithSector:function(a,t){var e=Math.abs(a.x-t.x-t.w/2),r=Math.abs(a.y-t.y-t.h/2);if(e>t.w/2+a.r)return!1;if(r>t.h/2+a.r)return!1;if(e<=t.w/2)return!0;if(r<=t.h/2)return!0;var h=e-t.w/2,i=r-t.h/2;return h*h+i*i<=a.r*a.r},mapDrawCell:function(a,t,e,r,h,i,l,s){0!==r[4]&&h&&(t=38*(t+.5),e=38*(e+.5),a.save(),a.translate(t,e),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[3]==r[4],r[0]==r[4],r[1]==r[4],l),i,h,s),a.restore(),a.save(),a.translate(t,e),a.rotate(.5*Math.PI),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[1]==r[4],r[2]==r[4],r[5]==r[4],l),i,h,s),a.restore(),a.save(),a.translate(t,e),a.rotate(Math.PI),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[5]==r[4],r[8]==r[4],r[7]==r[4],l),i,h,s),a.restore(),a.save(),a.translate(t,e),a.rotate(1.5*Math.PI),this.mapDrawBorderLine(a,this.mapGetSectorLine(r[7]==r[4],r[6]==r[4],r[3]==r[4],l),i,h,s),a.restore())},mapDrawBorderLine:function(a,t,e,r,h){if(!(t.length<1)){for(var i,l,s,n,o,c,p,u,d,f,v,M,y,m,w,T,B,g=2,W=[],I=0;I<t.length-2;I+=2)i=t[I],l=t[I+1],s=t[I+2],n=t[I+3],p=(o=s-i)*o+(c=n-l)*c,u=Math.sqrt(p),W[I]=c/u,W[I+1]=-o/u;var _=a.globalCompositeOperation,x=a.fillStyle;for(h||(a.fillStyle="rgba("+r[0]+","+r[1]+","+r[2]+",.7)");null!=t[g+4];)i=t[g],l=t[g+1],s=t[g+2],n=t[g+3],w=W[g-2],T=W[g-1],v=W[g],M=W[g+1],y=W[g+2],m=W[g+3],d=v,f=M,y+=v,m+=M,v+=w,M+=T,(u=Math.sqrt(y*y+m*m))>0&&(y/=u,m/=u),(u=Math.sqrt(v*v+M*M))>0&&(v/=u,M/=u),h&&((B=a.createLinearGradient(i,l,i+d*e,l+f*e)).addColorStop(0,"rgba("+r[0]+","+r[1]+","+r[2]+","+h+")"),B.addColorStop(1,"rgba("+r[0]+","+r[1]+","+r[2]+",0)"),a.fillStyle=B),a.beginPath(),a.moveTo(i,l),a.lineTo(s,n),a.lineTo(s+y*e,n+m*e),a.lineTo(i+v*e,l+M*e),a.closePath(),a.fill(),g+=2;a.fillStyle=x,a.globalCompositeOperation=_}},mapGetSectorLine:function(a,t,e,r){var h=[],i=0,l=.9,s=19;return a||e?!a||e||t||(h[i++]=r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=-s,h[i++]=-r*l,h[i++]=2*-r,h[i++]=-r*l):(h[i++]=r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=.1*-r,h[i++]=-r*l,h[i++]=.35*-r*l,h[i++]=.95*-r*l,h[i++]=-r*Math.SQRT1_2*l,h[i++]=-r*Math.SQRT1_2*l,h[i++]=.95*-r*l,h[i++]=.35*-r*l,h[i++]=-r*l,h[i++]=.1*-r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=r),a&&!e&&t&&(h[i++]=r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=.2*-r,h[i++]=-r*l,h[i++]=.6*-r,h[i++]=-r,h[i++]=.2*r-s,h[i++]=-s-.2*r,h[i++]=2*-r,h[i++]=2.4*-r),a||!e||t||(h[i++]=-r*l,h[i++]=2*-r,h[i++]=-r*l,h[i++]=-s,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=r),!a&&e&&t&&(h[i++]=2.4*-r,h[i++]=2*-r,h[i++]=-s-.2*r,h[i++]=.2*r-s,h[i++]=-r,h[i++]=.6*-r,h[i++]=-r*l,h[i++]=.2*-r,h[i++]=-r*l,h[i++]=0,h[i++]=-r*l,h[i++]=r),h},churchInBound:function(a,t,e,r,h){var i=a-e,l=t-r;return i*i+l*l<=h},ellipse:function(a,t,e,r,h,i,l,s,n){a.save(),a.translate(t,e),a.rotate(i),a.scale(r,h),a.arc(0,0,1,l,s,n),a.restore()},drawMapRadiusByLevel:function(a,t,e,r,h,i){for(var l=[!1,!1,!1,!1,!1,!1,!1,!1,!1],s=0;s<t.length;s++){var n=t[s][0],o=t[s][1],c=i>0?Math.pow(2+2*i,2):0;l=[l[0]||this.churchInBound(r-1,h-1,n,o,c),l[1]||this.churchInBound(r,h-1,n,o,c),l[2]||this.churchInBound(r+1,h-1,n,o,c),l[3]||this.churchInBound(r-1,h,n,o,c),l[4]||this.churchInBound(r,h,n,o,c),l[5]||this.churchInBound(r+1,h,n,o,c),l[6]||this.churchInBound(r-1,h+1,n,o,c),l[7]||this.churchInBound(r,h+1,n,o,c),l[8]||this.churchInBound(r+1,h+1,n,o,c)]}var p=i>3&&i<0?this.church_radius_colors[0]:this.church_radius_colors[i];this.mapDrawCell(a,r-e.x,h-e.y,l,p,19,19,.5)}};