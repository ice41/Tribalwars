TWMap.initMap=function(){$("#map_blend").hide(),this.mapHandler.scrollBound=this.scrollBound;var e=new FreeMap(document.getElementById("minimap"),[5,5],50,this.minimapHandler,0);if(e.createMover(1),this.minimap=e,this.minimapWidth=$("#minimap").width(),this.minimapHeight=$("#minimap").height(),this.minimapHandler.scrollBound=this.getMinimapScrollBound(),TWMap.minimap_only)this.scaleMinimap();else{var a,i=new FreeMap(document.getElementById("map"),this.tileSize,this.mapSubSectorSize,this.mapHandler,26500);for($.browser.msie,i.createMover(this.mobile?1:2),this.map=i,this.scaleMinimap(),this.minimapHandler.scrollBound=this.getMinimapScrollBound(),this.map_el_coordx=document.getElementById("map_coord_x"),this.map_el_coordy=document.getElementById("map_coord_y"),this._coord_el_y=[],this._coord_el_y_active=[],this._coord_el_x=[],this._coord_el_x_active=[],a=0;a<1e3;a++){var t;(t=document.createElement("div")).style.height=this.map.scale[1]+"px",t.style.lineHeight=this.map.scale[1]+"px",t.style.verticalAlign="middle",t.style.position="absolute",t.style.top=a*this.map.scale[1]-this.map.bias+"px",t.style.left="0px",t.innerHTML=a,this._coord_el_y.push(t),this._coord_el_y_active.push(!1),(t=document.createElement("div")).style.width=this.map.scale[0]+"px",t.style.textAlign="center",t.style.position="absolute",t.style.left=a*this.map.scale[0]-this.map.bias+"px",t.style.top="0px",t.innerHTML=a,this._coord_el_x.push(t),this._coord_el_x_active.push(!1)}this.popup.init(),mobile||CommandPopup.hookCommandSent(function(e){TWMap.premium&&"attack"===e.type&&(TWMap.updateCommandIcon(e.target_village,"attack",!0),TWMap.popup.invalidateVillage(e.target_village.id)),TWMap.premium&&"support"===e.type&&(TWMap.updateCommandIcon(e.target_village,"incoming_support",!0),TWMap.popup.invalidateVillage(e.target_village.id))}),$(document).keydown(TWMap.onKeyDown),$(document).keyup(TWMap.onKeyUp),"undefined"!=typeof AttackPlanner&&AttackPlanner.init()}},TWMap.focus=function(e,a){e=~~Math.max(e,this.scrollBound.x_min+this.size[0]/2),a=~~Math.max(a,this.scrollBound.y_min+this.size[1]/2);e=Math.min(e,this.scrollBound.x_max+1-this.size[0]/2),a=Math.min(a,this.scrollBound.y_max+1-this.size[1]/2),TWMap.map&&TWMap.map.centerPos(e,a,!0),TWMap.minimap_only&&TWMap.minimap.centerPos(e,a,!0),TWMap.pos=[e,a],TWMap.home.updateDisplay()},TWMap.mapHandler.spawnSector=function(e,a){if(!TWMap.minimap_only){var i=a.x-e.x,t=i+TWMap.mapSubSectorSize,p=a.y-e.y,s=p+TWMap.mapSubSectorSize;(TWMap.church.displayed||TWMap.church.possible_displayed||TWMap.politicalMap.displayed||TWMap.attackPlannerMode||TribalWars._settings.map_show_watchtower)&&MapCanvas.createCanvas(a,e),a.dom_fragment=document.createDocumentFragment();var o,n=this._createBorder(a.x%100==0);if("map_con_border"==n.className?n.style.width="3px":n.style.width="1px",n.style.height=TWMap.mapSubSectorSize*TWMap.tileSize[1]+"px",a.appendElement(n,0,0),"map_con_border"==(n=this._createBorder(a.y%100==0)).className?n.style.height="3px":n.style.height="1px",n.style.width=TWMap.mapSubSectorSize*TWMap.tileSize[0]+"px",a.appendElement(n,0,0),TWMap.ghost){var l=TWMap.ghost.x,r=TWMap.ghost.y;if(l>=a.x&&l<a.x+TWMap.mapSubSectorSize&&r>=a.y&&r<a.y+TWMap.mapSubSectorSize){TWMap.ghost.x,TWMap.ghost.y;TWMap.villages[1e3*l+r]={owner:0,points:0,img:TWMap.ghost_village_tile,special:"ghost"}}}for(o in e.tiles){var m;if(e.tiles.hasOwnProperty(o))if(!((o=parseInt(o))<i||o>=t))for(m in e.tiles[o])if(e.tiles[o].hasOwnProperty(m)&&!((m=parseInt(m))<p||m>=s)){var d=document.createElement("img");d.style.position="absolute",d.style.zIndex="2";var c=TWMap.villages[1e3*(e.x+o)+e.y+m];if(c){var M=c.owner,h=c.owner>0&&TWMap.players[c.owner]?TWMap.players[c.owner].ally:0,W=null;if(c.id==game_data.village.id?W=TWMap.colors.this:TWMap.villageColors[c.id]?W=TWMap.villageColors[c.id]:0!=c.owner?W=TWMap.getColorByPlayer(M,h,c.id):c.ally_id&&(W=TWMap.getColorByPlayer(0,c.ally_id,c.id))&&(W=TWMap.createVillageDot(W)),W){var T=TWMap.createVillageDot(W);a.appendElement(T,o-i,m-p)}imgsrc=TWMap.images[c.img],d.id="map_village_"+c.id,d.setAttribute("src",TWMap.graphics+imgsrc),d.style.width="53px",d.style.height="38px",!TribalWars._settings.map_casual_hide||parseInt(c.owner)===parseInt(game_data.player.id)||-1===$.inArray(c.owner,TWMap.non_attackable_players)&&-1===$.inArray(c.id,TWMap.non_attackable_villages)||(d.style.opacity=.4,d.style.filter="alpha(opacity=40)");var y,u=TWMap.createVillageIcons(c);for(y=0;y<u.length;y++)a.appendElement(u[y],o-i,m-p);$(d).mouseout(TWMap.popup.hide())}else d.setAttribute("src",TWMap.graphics+TWMap.images[e.tiles[o][m]]),d.style.width="53px",d.style.height="38px";a.appendElement(d,o-i,m-p)}}a._element_root.appendChild(a.dom_fragment),a.dom_fragment=void 0}},TWMap.scrolling=!1,TWMap.scrollBlock=function(e,a){if(!this.scrolling){this.scrolling=!0;var i=[TWMap.pos[0]+TWMap.size[0]*e,TWMap.pos[1]+TWMap.size[1]*a],t=setInterval(function(){if(-1==e&&TWMap.map.viewport[0]<=TWMap.scrollBound.x_min||-1==a&&TWMap.map.viewport[1]<=TWMap.scrollBound.y_min||1==e&&TWMap.map.viewport[2]>=TWMap.scrollBound.x_max||1==a&&TWMap.map.viewport[3]>=TWMap.scrollBound.y_max)return clearInterval(t),void(TWMap.scrolling=!1);if(e>0&&TWMap.pos[0]>=i[0]||e<0&&TWMap.pos[0]<=i[0]||a>0&&TWMap.pos[1]>=i[1]||a<0&&TWMap.pos[1]<=i[1])return clearInterval(t),void(TWMap.scrolling=!1);var p=[TWMap.pos[0],TWMap.pos[1]];TWMap.pos[0]!=i[0]&&(p[0]+=e),TWMap.pos[1]!=i[1]&&(p[1]+=a),TWMap.focus(p[0],p[1])},30)}},TWMap._resizeID=null,TWMap.resizeMinimap=function(e,a){var i=e*this.minimap.scale[0],t=e*this.minimap.scale[1];TWMap.minimap.resize(i,t,a||!1),setTimeout(function(){TWMap.notifyMapSize()},250)},TWMap.resize=function(e,a){0==e?(dstWidth=$(window).width(),dstHeight=Math.max(window.outerHeight,window.innerHeight),TWMap.fullscreen||(dstWidth-=100,dstHeight-=100),this.isAutoSize=!0):"number"==typeof e?(dstWidth=e*this.map.scale[0],dstHeight=e*this.map.scale[1],this.isAutoSize=!1):(dstWidth=e[0]*this.map.scale[0],dstHeight=e[1]*this.map.scale[1],this.isAutoSize=!1),$.browser.msie&&(a=!1),TWMap.map.resize(dstWidth,dstHeight,a?1:0),TWMap.home.updateDisplay()},TWMap.minimapHandler.onResize=function(e,a){TWMap.scaleMinimap()},TWMap.mapHandler.onResizeBegin=function(){TWMap.isAutoSize=!1,TWMap.isDragResizing=!0,TWMap.popup.unregister()},TWMap.mapHandler.onResizeEnd=function(){TWMap.notifyMapSize(!1),TWMap.isDragResizing=!1,TWMap.popup.register();var e=$("#map_coord_y_wrap");e.css("height",e.height()-17+"px")},TWMap.minimapHandler.onResizeEnd=function(){TWMap.notifyMapSize(!1),TWMap.positionMinimap()},TWMap.mapHandler.onResize=function(e,a){TWMap.scaleMinimap(),TWMap.size=TWMap.map.coordByPixel(e,a,!1),TWMap.isDragResizing||TWMap.notifyMapSize(TWMap.isAutoSize)},TWMap.mapHandler.getResizableElements=function(){return[[document.getElementById("map_coord_x_wrap")],[document.getElementById("map_coord_y_wrap")]]},TWMap.onKeyDown=function(e){var a=document.activeElement,i="INPUT"===a.tagName&&"text"===a.type;if("undefined"!=typeof HotKeys&&HotKeys.enabled&&!i){TWMap.keys[e.keyCode]=!0;var t=TWMap.map.pos,p=[0,0];TWMap.keys.hasOwnProperty(37)&&(p[0]-=15),TWMap.keys.hasOwnProperty(38)&&(p[1]-=15),TWMap.keys.hasOwnProperty(39)&&(p[0]+=15),TWMap.keys.hasOwnProperty(40)&&(p[1]+=15),0==p[0]&&0==p[1]||(e.preventDefault(),TWMap.map.setPosPixel(t[0]+p[0],t[1]+p[1]))}},TWMap.onKeyUp=function(e){"undefined"!=typeof HotKeys&&HotKeys.enabled&&delete TWMap.keys[e.keyCode]};