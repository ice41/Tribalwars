<?php$query_string = '';foreach ($cl_units->get_array('dbname') as $key => $unit) {	if (!in_array('no_investigate',$cl_units->get_specials($unit))) {		$query_string .= ','.$unit.'_tec_level';		}			if (!in_array('no_investigate',$cl_units->get_specials($unit))) {	    $jednostki[$unit]['nazwa'] = $key;		$jednostki[$unit]['koszt_bh'] = $cl_units->get_bhprice($unit);		$jednostki[$unit]['koszt_wood'] = $cl_units->get_woodprice($unit);		$jednostki[$unit]['koszt_stone'] = $cl_units->get_stoneprice($unit);		$jednostki[$unit]['koszt_iron'] = $cl_units->get_ironprice($unit);		$jednostki[$unit]['rekrutuj_w'] = $cl_units->recruit_in[$unit];		$jednostki[$unit]['koszt_bh'] = $cl_units->get_bhprice($unit);	    }	}	$impl_units = implode(',',$cl_units->get_array('dbname'));$villages_massrek_query .= "bonus,r_wood,r_stone,r_iron,r_bh,barracks,smith,stable,garage,farm,storage$query_string";$units_massrek_query = "villages_from_id,$impl_units";	foreach ($wioski_usera as $wioska) {	reload_vdata($wioska['id'],date("U"));	$wioska_info = sql("SELECT $villages_massrek_query FROM `villages` WHERE `id` = '".$wioska['id']."'",'assoc');	$wioska_info_army = sql("SELECT $units_massrek_query FROM `unit_place` WHERE `villages_from_id` = '".$wioska['id']."' AND `villages_to_id` = '".$wioska['id']."'",'assoc');			if ($wioska_info['bonus'] == 9) {		$masowa_rek_wioski[$wioska['id']]['wolni_osadnicy'] = floor(($arr_farm[$wioska_info['farm']] * ($bonus->bonusy[$wioska_info['bonus']]['modifer'] + 1)) - $wioska_info['r_bh']);		} else {		$masowa_rek_wioski[$wioska['id']]['wolni_osadnicy'] = $arr_farm[$wioska_info['farm']] - $wioska_info['r_bh'];		}	$masowa_rek_wioski[$wioska['id']]['r_wood'] = floor($wioska_info['r_wood']);	$masowa_rek_wioski[$wioska['id']]['r_stone'] = floor($wioska_info['r_stone']);	$masowa_rek_wioski[$wioska['id']]['r_iron'] = floor($wioska_info['r_iron']);	$masowa_rek_wioski[$wioska['id']]['id'] = $wioska['id'];	$masowa_rek_wioski[$wioska['id']]['x'] = $wioska['x'];	$masowa_rek_wioski[$wioska['id']]['y'] = $wioska['y'];	$masowa_rek_wioski[$wioska['id']]['name'] = $wioska['name'];	$masowa_rek_wioski[$wioska['id']]['continent'] = $wioska['continent'];	$masowa_rek_wioski[$wioska['id']]['bonus'] = $wioska_info['bonus'];	$masowa_rek_wioski[$wioska['id']]['budynki'] = array('barracks' => $wioska_info['barracks'],'smith' => $wioska_info['smith'],'stable' => $wioska_info['stable'],'garage' => $wioska_info['garage']);	foreach ($jednostki as $key => $info) {		$masowa_rek_wioski[$wioska['id']]['tech_'.$key] = $wioska_info[$key.'_tec_level'];		$masowa_rek_wioski[$wioska['id']][$key] = $wioska_info_army[$key];		}	}		if (isset($_POST["submitex"])) {     foreach($masowa_rek_wioski as $pv) {		foreach($jednostki AS $key => $jednostka) {	        $post_value = (int)$_POST['massrek_'.$pv['id'].'-'.$key];			if ($post_value < 0) {				$post_value = 0;				}			$post_value = floor($post_value);					    ////Obliczanie wszystkich kosztów wybranych jednostek do rekrutowania/////					    $koszt[$jednostka['nazwa_php']]['kamienie'] = $jednostka['koszt_stone'] * $post_value;		    $koszt[$jednostka['nazwa_php']]['drewno'] = $jednostka['koszt_wood'] * $post_value;		    $koszt[$jednostka['nazwa_php']]['ruda'] = $jednostka['koszt_iron'] * $post_value;		    $koszt[$jednostka['nazwa_php']]['bh'] = $jednostka['koszt_bh'] * $post_value;				    $koszty_razem[$pv['id']]['kamienie'] += $koszt[$jednostka['nazwa_php']]['kamienie'];			$koszty_razem[$pv['id']]['drewno'] += $koszt[$jednostka['nazwa_php']]['drewno'];			$koszty_razem[$pv['id']]['ruda'] += $koszt[$jednostka['nazwa_php']]['ruda'];			$koszty_razem[$pv['id']]['bh'] += $koszt[$jednostka['nazwa_php']]['bh'];			}					if($koszty_razem[$pv['id']]['kamienie'] >  $pv['r_stone'] || $koszty_razem[$pv['id']]['drewno'] > $pv['r_wood'] || $koszty_razem[$pv['id']]['ruda'] > $pv['r_iron'] || $koszty_razem[$pv['id']]['bh'] > $pv['wolni_osadnicy']) {			} else {		    foreach ($jednostki AS $key => $jednostka) {                $post_value = (int)$_POST['massrek_'.$pv['id'].'-'.$key];			    if ($post_value < 0) {				    $post_value = 0;				    }				$post_value = floor($post_value);				                if ($post_value > 0) {									/////////Zabierz surowce z osady, oraz rozpocznij trening jednostki/////					$budynek_stage = $pv['budynki'][$jednostka['rekrutuj_w']];					$cl_units->recruit_units($key,$post_value,$jednostka['rekrutuj_w'],$budynek_stage,$pv['id']);	                    }								    }			$cl_units->odejmij_surowce($pv['id'],$koszty_razem[$pv['id']]['kamienie'],$koszty_razem[$pv['id']]['drewno'],$koszty_razem[$pv['id']]['ruda'],$koszty_razem[$pv['id']]['bh']);            }			        }	    header('location: game.php?village='.$_GET["village"].'&screen=masowa_rekrutacja');    exit;				    }		$tpl->assign('cl_units',$cl_units);$tpl->assign('units',$jednostki);$tpl->assign('masowa_rek_wioski',$masowa_rek_wioski);?>