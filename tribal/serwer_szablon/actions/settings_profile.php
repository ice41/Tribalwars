<?php//Start klasy bb_interpreter();$bb_interpreter = new bb_interpreter($cl_builds,$cl_units,$pl);$settings_info = sql("SELECT b_day,b_month,b_year,sex,home,image,personal_text,personal_text_bb FROM `users` WHERE `id` = '".$user['id']."'",'assoc');$settings_info['personal_text'] = $bb_interpreter->load_bb($settings_info['personal_text'],$village['id']);$settings_info['personal_text_bb'] = entparse($settings_info['personal_text_bb']);$settings_info['home'] = entparse($settings_info['home']);if ($_GET['action'] === 'change_profile' && count($_POST) > 0) {	if ($_GET['h'] == $session['hkey']) {		//Walidacja danych:		$sexes = array('f','m','x');		$_POST['day'] = (int)$_POST['day'];		$_POST['month'] = (int)$_POST['month'];		$_POST['year'] = (int)$_POST['year'];		$_POST['home'] = cmp_str($_POST['home'],0,75);		if (!in_array($_POST['sex'],$sexes)) {			$_POST['sex'] = 'x';			}		$data = explode('-',date("Y-m-d"));		$rok = $data[0];				if ($_POST['year'] < ($rok - 100)) {			$_POST['year'] = ($rok - 100);			}		if ($_POST['year'] > $rok) {			$_POST['year'] = $rok;			}					if ($_POST['month'] < 1) {			$_POST['month'] = 1;			}		if ($_POST['month'] > 12) {			$_POST['month'] = 12;			}					$days = cal_days_in_month(CAL_GREGORIAN, $_POST['month'], $_POST['year']);				if ($_POST['day'] < 1) {			$_POST['day'] = 1;			}		if ($_POST['day'] > $days) {			$_POST['day'] = $days;			}					if ($_POST['home'] === 'LONG') {			$error = 'Local de residência pode sk enviados em um máximo de 75 caracteres';			}		elseif ($_POST['home'] === 'SPACES') {			$error = 'Local de residência não podem ser enviados em uma composição do mesmo espaço';			} else {			$_POST['home'] = parse($_POST['home']);			mysql_query("UPDATE `users` SET `home` = '".$_POST['home']."' WHERE `id` = '".$user['id']."'");			}					mysql_query("UPDATE `users` SET `sex` = '".$_POST['sex']."' , `b_day` = '".$_POST['day']."' , `b_month` = '".$_POST['month']."' , `b_year` = '".$_POST['year']."'WHERE `id` = '".$user['id']."'");				if (is_array($_FILES['image'])) {			if (file_exists($_FILES['image']['tmp_name'])) {				if ($_FILES['image']['size'] < 120000) {					if ($_FILES['image']['type'] == 'image/png' || $_FILES['image']['type'] == 'image/jpeg' || $_FILES['image']['type'] == 'image/gif') {						$size = getimagesize($_FILES['image']['tmp_name']);						if (is_array($size) && $size[0] > 1 && $size[1] > 1) {							if ($size[0] > 240 || $size[1] > 180) {								$error = 'Maksymalne wymiary obrazka to 240x180.';								} else {								if ($_FILES['image']['type'] == 'image/png') {									$format = 'png';									}								if ($_FILES['image']['type'] == 'image/jpeg') {									$format = 'jpg';									}								if ($_FILES['image']['type'] == 'image/gif') {									$format = 'gif';									}								$filename = 'graphic/player/' . $user['id'] . '.' . $format;								copy ($_FILES['image']['tmp_name'],$filename);																mysql_query("UPDATE `users` SET `image` = '".($user['id'] . '.' . $format)."' WHERE `id` = '".$user['id']."'");								}							} else {							$error = 'B³¹d pliku graficznego.';							}						} else {						$error = 'Wysy³any plik nie jest grafik¹.';						}					} else {					$error = 'Maksymalny rozmiar grafiki to 120kb.';					}				}			}					if (isset($_POST['del_image'])) {			if (file_exists('graphic/player/' . $user['image'])) {				unlink('graphic/player/' . $user['image']);				mysql_query("UPDATE `users` SET `image` = '' WHERE `id` = '".$user['id']."'");				}			}				if (empty($error)) {			header('location: game.php?village='.$village['id'].'&screen=settings&mode=profile');			exit;			}			} else {		$error = 'B³¹d podczas wykonywania akcji';		}	}	if ($_GET['action'] === 'change_text' && count($_POST) > 0) {	if ($_GET['h'] == $session['hkey']) {		$str_err = cmp_str($_POST['text'],0,5000);				if ($str_err === 'LONG') {			$error = 'O texto pode ser enviado no máximo em uma composição de 5000 caracteres';			}		elseif ($str_err === 'SPACES') {			$error = 'O texto não pode ser enviada de uma composição do mesmo espaço';			} else {			$str_comp_bb = $bb_interpreter->compile_bb_code($str_err,$user['id']);			$str_err = parse($str_err);						mysql_query("UPDATE `users` SET `personal_text` = '".$str_comp_bb."' , personal_text_bb = '".$str_err."' WHERE `id` = '".$user['id']."'");						header('location: game.php?village='.$village['id'].'&screen=settings&mode=profile');			exit;			}		} else {		$error = 'B³¹d podczas wykonywania akcji';		}	}	$tpl->assign('settings',$settings_info);$tpl->assign('error',$error);?>